# HOL-4: Exercise 5: Explore Azure Arc integration and Azure services

## Overview

Now that you have create a Kubernetes cluster and a Virtual Machine in your Azure Stack HCI, you can now explore Azure Arc and other Azure services.

Contents
-----------
- [Overview](#overview)
- [Contents](#contents)
- [Arc-enable the VM you just created](#task-1-arc-enable-the-vm-you-just-created)
- [Access an Azure Arc-enable VM over SSH without direct connectivity enabled](#task-2-access-an-azure-arc-enable-vm-over-ssh-without-direct-connectivity-enabled)
- [Arc-enable the VM you just created](#task-1-arc-enable-the-vm-you-just-created)

Task 1: Arc-enable the VM you just created
----
In this step, you will Azure Arc-enable your Ubuntu Server 20.04 virtual machine your created in the previous exercise.

### Arc-enable your Ubuntu Server 20.04 Virtual Machine ###
1. From the start menu of the Hybridhost001, search for **CMD** and open it with double click or other way.

    ![](.././media/startputty.png "Search Putty")
    
1. In the Putty Configuration tool, enter the **VM002** VM private IP - ```192.168.0.12``` (remember your assigned ip address!), make sure the Port value is ```22```. Once you entered the private IP of the **VM002** vm, click on the Open to lunch the terminal.


    
1. Enter the **VM002** vm username - ```demouser``` in **login as** and then hit **Enter**. 

   ```
   demouser
   ```

    ```Add screenshot```

1. Now, enter the password - ```demo!pass123``` and press **Enter**. Remember password will be hidden and will not be visible in terminal.

   ```
   demo!pass123
   ```

    ```Add screenshot```
    
    > Note: To paste any value in Putty terminal, just copy the values from anywhere and then right click on the terminal to paste the copied value.

1. Login with Sudo. Run the following command and provide the Password `demo!pass123`.

   ```
   sudo su
   ```
   
   ```
   demo!pass123
   ```
    ```Add screenshot```

1. Install the lastest Azure CLI. Run the following command ```curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash``` and run ```az version``` to confirm the Azure Cli is working properly.

    ```
    curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
    ```
     ```Add screenshot```
    ```
    az version
    ```
    ```Add screenshot```

1. Download the script which will download and install the lastest Azure Connected Machine Agent. Run the following command ```wget https://aka.ms/azcmagent -O ~/install_linux_azcmagent.sh```.
    ```
    wget https://aka.ms/azcmagent -O ~/install_linux_azcmagent.sh
    ```
     ```Add screenshot```

1. Since we are running this Lab on azure in a virtually nested environment we need to change the downloaded script. Run ```apt install nano```. Run ```nano /root/install_linux_azcmagent.sh``` and type **CTRL+_** (underscore). Go to Line **251** and change the ip address to ```169.254.169.250```. Type **CTRL+X** then **Y** and **ENTER** to save the file.
    ```
    apt install nano
    ```
    ```
    nano /root/install_linux_azcmagent.sh
    ```
      ```Add screenshot```   


1. Run the script which will download and install the lastest Azure Connected Machine Agent you just downloaded. Run the following command ```bash ~/install_linux_azcmagent.sh``` to install the Azure Connected Machine Agent on VM002.
    
    ```
    bash ~/install_linux_azcmagent.sh
    ```
     ```Add screenshot```        

1. Now Arc-enable vm002. Run the the following command ```sudo azcmagent connect --resource-group "ResourceGroup" --tenant-id "TenantID" --location "eastus" --subscription-id "SubscriptionID" --cloud "AzureCloud"```, where the resource group is ```HybridHost```. Check the Lab Environment details for the right TenantID and SubscriptionID.
    ```
    sudo azcmagent connect --resource-group "HybridHost" --tenant-id "********-****-****-****-************" --location "eastus" --subscription-id "********-****-****-****-****-************" --cloud "AzureCloud
    ```
    > Note: We are not using a Service Principal to Arc-enable vm002, so we will be prompted for a devicelogin verification. Open an extra browser tab on the HybridHost001 and open ```https://aka.ms/devicelogin``` and type the given code. Sign in with your Lab Environment Azure credentials.

     ```Add screenshot```

1. Check if vm002 is properly Azure Arc-enabled properly. Run the the following command ```azcmagent show```. You show see an Agent Status of Connected.    
    ```
    azcmagent show
    ```
     ```Add screenshot```  

Task 2: Access an Azure Arc-enable VM over SSH without direct connectivity enabled
----
In this step, you will setup SSH connectivity to an Azure Arc-enabled virtual machine without direct connectivity enabled.

1. From the start menu of the Hybridhost001, search for **CMD** and open it with double click or other way.

    ![](.././media/startputty.png "Search Putty")
    
1. In the Putty Configuration tool, enter the **VM002** VM private IP - ```192.168.0.12``` (remember your assigned ip address!), make sure the Port value is ```22```. Once you entered the private IP of the **VM002** vm, click on the Open to lunch the terminal.


    
1. Enter the **VM002** vm username - ```demouser``` in **login as** and then hit **Enter**. 

   ```
   demouser
   ```

    ```Add screenshot```

1. Now, enter the password - ```demo!pass123``` and press **Enter**. Remember password will be hidden and will not be visible in terminal.

   ```
   demo!pass123
   ```

    ```Add screenshot```
    
    > Note: To paste any value in Putty terminal, just copy the values from anywhere and then right click on the terminal to paste the copied value.

1. Login with Sudo. Run the following command and provide the Password `demo!pass123`.

   ```
   sudo su
   ```
   
   ```
   demo!pass123
   ```
    ```Add screenshot```

1. Install the lastest Azure CLI. Run the following command ```curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash``` and run ```az version``` to confirm the Azure Cli is working properly.

    ```
    curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
    ```
     ```Add screenshot```
    ```
    az version
    ```
    ```Add screenshot```

1. Download the script which will download and install the lastest Azure Connected Machine Agent. Run the following command ```wget https://aka.ms/azcmagent -O ~/install_linux_azcmagent.sh```.
    ```
    wget https://aka.ms/azcmagent -O ~/install_linux_azcmagent.sh
    ```
     ```Add screenshot```

1. Since we are running this Lab on azure in a virtually nested environment we need to change the downloaded script. Run ```apt install nano```. Run ```nano /root/install_linux_azcmagent.sh``` and type **CTRL+_** (underscore). Go to Line **251** and change the ip address to ```169.254.169.250```. Type **CTRL+X** then **Y** and **ENTER** to save the file.
    ```
    apt install nano
    ```
    ```
    nano /root/install_linux_azcmagent.sh
    ```
      ```Add screenshot```   


1. Run the script which will download and install the lastest Azure Connected Machine Agent you just downloaded. Run the following command ```bash ~/install_linux_azcmagent.sh``` to install the Azure Connected Machine Agent on VM002.
    
    ```
    bash ~/install_linux_azcmagent.sh
    ```
     ```Add screenshot```        

1. Now Arc-enable vm002. Run the the following command ```sudo azcmagent connect --resource-group "ResourceGroup" --tenant-id "TenantID" --location "eastus" --subscription-id "SubscriptionID" --cloud "AzureCloud"```, where the resource group is ```HybridHost```. Check the Lab Environment details for the right TenantID and SubscriptionID.
    ```
    sudo azcmagent connect --resource-group "HybridHost" --tenant-id "********-****-****-****-************" --location "eastus" --subscription-id "********-****-****-****-****-************" --cloud "AzureCloud
    ```
    > Note: We are not using a Service Principal to Arc-enable vm002, so we will be prompted for a devicelogin verification. Open an extra browser tab on the HybridHost001 and open ```https://aka.ms/devicelogin``` and type the given code. Sign in with your Lab Environment Azure credentials.

     ```Add screenshot```

1. Check if vm002 is properly Azure Arc-enabled properly. Run the the following command ```azcmagent show```. You show see an Agent Status of Connected.    
    ```
    azcmagent show
    ```
     ```Add screenshot```  


Task 3: Explore Azure Hybrid Services in WAC
----

Relevant documentation:

[Connecting to Azure Hybrid Services](https://docs.microsoft.com/en-us/windows-server/manage/windows-admin-center/azure/)


Task 4: Arc-enabled the Windows Server 2019 VM (vm001) you just created
----

Relevant documentation: 

[Plan and deploy Azure Arc-enabled servers](https://docs.microsoft.com/en-us/azure/azure-arc/servers/plan-at-scale-deployment)

Task 3: Apply Azure Policy, VM Insights and Azure Defender for your VM and Kubernetes cluster
----

Relevant documentation: 

[Azure Policy built-in definitions for Azure Arc-enabled servers](https://docs.microsoft.com/en-us/azure/azure-arc/servers/policy-reference)
[Azure Policy built-in definitions for Azure Arc-enabled Kubernetes](https://docs.microsoft.com/en-us/azure/azure-arc/kubernetes/policy-reference)

[Azure Monitor Container Insights for Azure Arc-enabled Kubernetes clusters](https://docs.microsoft.com/en-us/azure/azure-monitor/containers/container-insights-enable-arc-enabled-clusters#create-extension-instance-using-azure-portal)
[Monitor a hybrid machine with VM insights](https://docs.microsoft.com/en-us/azure/azure-arc/servers/learn/tutorial-enable-vm-insights)

[Protect non-Azure resources using Azure Arc and Azure Security Center](https://techcommunity.microsoft.com/t5/azure-security-center/protect-non-azure-resources-using-azure-arc-and-azure-security/ba-p/2277215)

Task 4: Enable Azure Backup for your nodes and VMs
----

Relevant documentation: 

[Backup your Windows Servers from Windows Admin Center with Azure Backup](https://docs.microsoft.com/en-us/windows-server/manage/windows-admin-center/azure/azure-backup#setup-azure-backup)
[Back up Azure Stack HCI virtual machines with Azure Backup Server](https://docs.microsoft.com/en-us/azure/backup/back-up-azure-stack-hyperconverged-infrastructure-virtual-machines)

Task 5: Enable Azure Security Center 
----

Relevant documentation: 

[Protect Windows Admin Center resources with Security Center](https://docs.microsoft.com/en-us/azure/security-center/windows-admin-center-integration)




Congratulations
You've reached the end of the evaluation guide. In this guide you have:

* Deployed/Configured a Windows Server 2019 Hyper-V host in Azure to run your nested sandbox environment
* Deployed the AKS on Azure Stack HCI management cluster on your Windows Server 2019 Hyper-V environment
* Deployed a target cluster to run applications and services
* Optionally integrated with Azure Arc and deployed a sample application
* Set the foundation for further learning!

Great work!
**Setup the lab in your own Azure Subscription.**
This lab is based on the the following work by Matt McSpirit: https://github.com/mattmcspirit/hybridworkshop
If you want to setup the lab within your own Azure subscription and run through additional scenarios as well, you can go to the above GitHub repo and perform as mentioned.
